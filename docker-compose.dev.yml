
services:
  # PostgreSQL æ•°æ®åº“æœåŠ¡
  postgres:
    image: pgvector/pgvector:pg16
    command: postgres -c "log_statement=none" -c "log_min_messages=error" -c "log_min_error_statement=error"
    container_name: catwiki-postgres-dev
    env_file:
      - ./backend/.env
    environment:
      PGDATA: /var/lib/postgresql/data/pgdata
      LANG: C.UTF-8
    ports:
      # ä½¿ç”¨ 5433 ç«¯å£é¿å…ä¸æœ¬åœ° PostgreSQL å†²çª
      # å¦‚æœéœ€è¦ä½¿ç”¨ 5432ï¼Œè¯·å…ˆåœæ­¢æœ¬åœ° PostgreSQL æœåŠ¡
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - catwiki-network
    # èµ„æºé™åˆ¶ï¼ˆå¯é€‰ï¼Œé˜²æ­¢æ•°æ®åº“å ç”¨è¿‡å¤šèµ„æºï¼‰
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    # æ—¥å¿—é…ç½®
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    restart: unless-stopped

  # RustFS å¯¹è±¡å­˜å‚¨æœåŠ¡
  rustfs:
    image: rustfs/rustfs:1.0.0-alpha.76
    container_name: catwiki-rustfs-dev
    env_file:
      - ./backend/.env
    environment:
      # æ—¶åŒºè®¾ç½®
      - TZ=Asia/Shanghai
      # RustFS é…ç½® (ä» .env åŠ è½½)
    ports:
      # RustFS API ç«¯å£
      - "9000:9000"
      # RustFS Console ç«¯å£
      - "9001:9001"
    volumes:
      # RustFS æ•°æ®å­˜å‚¨ï¼ˆä½¿ç”¨å‘½åå·é¿å…æƒé™é—®é¢˜ï¼‰
      - rustfs_data:/data
      # RustFS æ—¥å¿—
      - rustfs_logs:/logs
      # æ—¶åŒºé…ç½®ï¼ˆLinux onlyï¼ŒWindows/Mac ä¼šè‡ªåŠ¨å¿½ç•¥ï¼‰
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - catwiki-network
    # èµ„æºé™åˆ¶
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    # æ—¥å¿—é…ç½®
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    restart: unless-stopped

  # åç«¯åˆå§‹åŒ–æœåŠ¡ï¼ˆåªåœ¨é¦–æ¬¡å¯åŠ¨æˆ–æ‰‹åŠ¨è§¦å‘æ—¶è¿è¡Œï¼‰
  # è´Ÿè´£ï¼š
  # 1. è¿è¡Œæ•°æ®åº“è¿ç§»ï¼ˆalembic upgrade headï¼‰
  # 2. åˆ›å»ºåˆå§‹ç®¡ç†å‘˜ç”¨æˆ·ï¼ˆadmin@example.com / admin123ï¼‰
  # 3. åˆ›å»º Demo ç«™ç‚¹ï¼ˆåŒ»å­¦ç§‘æ™®ï¼‰å’Œåˆå§‹åŒ–åŒ»å­¦çŸ¥è¯†æ–‡æ¡£
  # 4. åˆå§‹åŒ– RustFS å¯¹è±¡å­˜å‚¨
  backend-init:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    image: catwiki-backend-init-dev
    container_name: catwiki-backend-init
    env_file:
      - ./backend/.env
    environment:
      # ç¯å¢ƒé…ç½®
      TZ: Asia/Shanghai
      
      # æ•°æ®åº“é…ç½®ï¼ˆä½¿ç”¨æœåŠ¡åè¿æ¥ï¼‰
      POSTGRES_SERVER: postgres
      POSTGRES_PORT: 5432
      
      # RustFS å¯¹è±¡å­˜å‚¨é…ç½® (ä» .env åŠ è½½ï¼ŒDocker å†…éƒ¨é€šä¿¡ä½¿ç”¨ RUSTFS_DOCKER_ENDPOINT)
      RUSTFS_ENDPOINT: ${RUSTFS_DOCKER_ENDPOINT:-rustfs:9000}
      
    volumes:
      # æŒ‚è½½ä»£ç ç›®å½•ä»¥è®¿é—®è„šæœ¬
      - ./backend:/app
      # æ’é™¤ä¸éœ€è¦åŒæ­¥çš„ç›®å½•
      - /app/.venv
      - /app/__pycache__
      - /app/**/__pycache__
    depends_on:
      postgres:
        condition: service_healthy
      rustfs:
        condition: service_healthy
    networks:
      - catwiki-network
    command: >
      sh -c "
        echo '==========================================' &&
        echo 'ğŸš€ å¼€å§‹åˆå§‹åŒ– CatWiki...' &&
        echo '==========================================' &&
        echo '' &&
        echo 'ğŸ“¦ è¿è¡Œæ•°æ®åº“è¿ç§»...' &&
        uv run alembic upgrade head &&
        echo 'âœ… æ•°æ®åº“è¿ç§»å®Œæˆ' &&
        echo '' &&
        echo ' åˆå§‹åŒ– Demo ç«™ç‚¹å’ŒåŒ»å­¦çŸ¥è¯†æ–‡æ¡£...' &&
        uv run python scripts/init_demo_data.py &&
        echo 'âœ… Demo æ•°æ®åˆå§‹åŒ–å®Œæˆ' &&
        echo '' &&
        echo 'ğŸ—„ï¸  åˆå§‹åŒ– RustFS å¯¹è±¡å­˜å‚¨...' &&
        uv run python scripts/init_rustfs.py &&
        echo 'âœ… RustFS åˆå§‹åŒ–å®Œæˆ' &&
        echo '' &&
        echo '==========================================' &&
        echo 'ğŸ‰ CatWiki åˆå§‹åŒ–å®Œæˆï¼' &&
        echo '==========================================' &&
        echo '' &&
        echo 'ğŸ“‹ é»˜è®¤ç®¡ç†å‘˜è´¦å·ï¼š' &&
        echo '   ğŸ“§ é‚®ç®±: admin@example.com' &&
        echo '   ğŸ”‘ å¯†ç : admin123' &&
        echo '' &&
        echo 'ğŸ“š Demo ç«™ç‚¹ï¼š' &&
        echo '   ğŸ”— è®¿é—®: http://localhost:8002/medical' &&
        echo '' &&
        echo 'ğŸ”§ ç®¡ç†åå°ï¼š' &&
        echo '   ğŸ”— è®¿é—®: http://localhost:8001' &&
        echo '' &&
        echo 'ğŸ“– API æ–‡æ¡£ï¼š' &&
        echo '   ğŸ”— è®¿é—®: http://localhost:3000/docs' &&
        echo '' &&
        echo 'ğŸ“š æ–‡æ¡£ç«™ç‚¹ï¼š' &&
        echo '   ğŸ”— è®¿é—®: http://localhost:8003' &&
        echo '' &&
        echo '==========================================' &&
        echo ''
      "
    # åˆå§‹åŒ–æœåŠ¡åªè¿è¡Œä¸€æ¬¡ï¼ŒæˆåŠŸåä¸é‡å¯
    restart: "no"
    # æ—¥å¿—é…ç½®
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "2"

  # åç«¯ API æœåŠ¡ï¼ˆæ”¯æŒçƒ­æ›´æ–°ï¼‰
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    image: catwiki-backend-dev
    container_name: catwiki-backend-dev
    env_file:
      - ./backend/.env
    environment:
      # æ—¶åŒºé…ç½®
      TZ: Asia/Shanghai
      
      # æ•°æ®åº“é…ç½®ï¼ˆä½¿ç”¨æœåŠ¡åè¿æ¥ï¼‰
      POSTGRES_SERVER: postgres
      POSTGRES_PORT: 5432
      
      # RustFS å¯¹è±¡å­˜å‚¨é…ç½® (ä» .env åŠ è½½ï¼ŒDocker å†…éƒ¨é€šä¿¡ä½¿ç”¨ RUSTFS_DOCKER_ENDPOINT)
      RUSTFS_ENDPOINT: ${RUSTFS_DOCKER_ENDPOINT:-rustfs:9000}
      
    ports:
      - "3000:3000"
    volumes:
      # æŒ‚è½½ä»£ç ç›®å½•ä»¥æ”¯æŒçƒ­æ›´æ–°
      - ./backend:/app
      # æ’é™¤ä¸éœ€è¦åŒæ­¥çš„ç›®å½•ï¼ˆä¿ç•™å®¹å™¨å†…çš„è™šæ‹Ÿç¯å¢ƒï¼‰
      - /app/.venv
      - /app/__pycache__
      - /app/**/__pycache__
      - /app/.git
      - /app/*.pyc
    depends_on:
      postgres:
        condition: service_healthy
      rustfs:
        condition: service_healthy
      backend-init:
        condition: service_completed_successfully
    networks:
      - catwiki-network
    # å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    # èµ„æºé™åˆ¶
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    # æ—¥å¿—é…ç½®
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    stdin_open: true
    tty: true
    restart: unless-stopped

  # Admin å‰ç«¯æœåŠ¡ï¼ˆç®¡ç†åå°ï¼Œæ”¯æŒçƒ­æ›´æ–°ï¼‰
  admin-frontend:
    build:
      context: ./frontend/admin
      dockerfile: Dockerfile.dev
    image: catwiki-admin-frontend-dev
    container_name: catwiki-admin-frontend-dev
    env_file:
      - ./frontend/admin/.env
    environment:
      - NODE_ENV=development
    ports:
      - "8001:8001"
    volumes:
      # æŒ‚è½½ä»£ç ç›®å½•ä»¥æ”¯æŒçƒ­æ›´æ–°
      - ./frontend/admin:/app
      - /app/node_modules
      - /app/.next
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - catwiki-network
    # èµ„æºé™åˆ¶ï¼ˆé€‚å½“æé«˜ä»¥åŠ é€Ÿ Next.js ç¼–è¯‘ï¼‰
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    # æ—¥å¿—é…ç½®
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"
    stdin_open: true
    tty: true
    restart: unless-stopped

  # Client å‰ç«¯æœåŠ¡ï¼ˆå®¢æˆ·ç«¯ï¼Œæ”¯æŒçƒ­æ›´æ–°ï¼‰
  client-frontend:
    build:
      context: ./frontend/client
      dockerfile: Dockerfile.dev
    image: catwiki-client-frontend-dev
    container_name: catwiki-client-frontend-dev
    env_file:
      - ./frontend/client/.env
    environment:
      - NODE_ENV=development
    ports:
      - "8002:8002"
    volumes:
      # æŒ‚è½½ä»£ç ç›®å½•ä»¥æ”¯æŒçƒ­æ›´æ–°
      - ./frontend/client:/app
      - /app/node_modules
      - /app/.next
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - catwiki-network
    # èµ„æºé™åˆ¶ï¼ˆé€‚å½“æé«˜ä»¥åŠ é€Ÿ Next.js ç¼–è¯‘ï¼‰
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    # æ—¥å¿—é…ç½®
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"
    stdin_open: true
    tty: true
    restart: unless-stopped

  # Docs æ–‡æ¡£ç«™ç‚¹æœåŠ¡ï¼ˆVitePressï¼Œæ”¯æŒçƒ­æ›´æ–°ï¼‰
  docs-frontend:
    build:
      context: ./frontend/docs
      dockerfile: Dockerfile.dev
    image: catwiki-docs-frontend-dev
    container_name: catwiki-docs-frontend-dev
    environment:
      - NODE_ENV=development
    ports:
      - "8003:8003"
    volumes:
      # æŒ‚è½½ä»£ç ç›®å½•ä»¥æ”¯æŒçƒ­æ›´æ–°
      - ./frontend/docs:/app
      - /app/node_modules
    networks:
      - catwiki-network
    # èµ„æºé™åˆ¶
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    # æ—¥å¿—é…ç½®
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"
    stdin_open: true
    tty: true
    restart: unless-stopped

volumes:
  postgres_data:
    driver: local
  rustfs_data:
    driver: local
  rustfs_logs:
    driver: local

networks:
  catwiki-network:
    driver: bridge

