
services:
  # PostgreSQL æ•°æ®åº“
  postgres:
    image: pgvector/pgvector:pg16
    container_name: catwiki-postgres-prod
    env_file:
      - .env.backend
    environment:
      PGDATA: /var/lib/postgresql/data/pgdata
      LANG: C.UTF-8
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - catwiki-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    # èµ„æºé™åˆ¶
    deploy:
      resources:
        limits:
          cpus: '0.8'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M

  # RustFS å¯¹è±¡å­˜å‚¨æœåŠ¡
  rustfs:
    image: rustfs/rustfs:1.0.0-alpha.76
    container_name: catwiki-rustfs-prod
    env_file:
      - .env.backend
    environment:
      - TZ=Asia/Shanghai
    volumes:
      - rustfs_data:/data
      - rustfs_logs:/logs
    networks:
      - catwiki-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    # èµ„æºé™åˆ¶
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M

  # åç«¯åˆå§‹åŒ–æœåŠ¡ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
  # è´Ÿè´£æ•°æ®åº“è¿ç§»å’Œåˆå§‹åŒ–
  # æ³¨æ„ï¼šç”Ÿäº§ç¯å¢ƒå»ºè®®åœ¨éƒ¨ç½²æµç¨‹ä¸­å•ç‹¬æ‰§è¡Œï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ¨ç½²éƒ½è¿è¡Œ
  backend-init:
    build:
      context: ../../backend
      dockerfile: Dockerfile.prod
    image: catwiki-backend-init:latest
    container_name: catwiki-backend-init-prod
    env_file:
      - .env.backend
    environment:
      # ç¯å¢ƒé…ç½®
      ENVIRONMENT: prod
      
      # æ•°æ®åº“é…ç½®
      POSTGRES_SERVER: postgres
      POSTGRES_PORT: 5432
      
      # RustFS å¯¹è±¡å­˜å‚¨é…ç½®
      RUSTFS_ENDPOINT: ${RUSTFS_ENDPOINT:-rustfs:9000}
    depends_on:
      postgres:
        condition: service_healthy
      rustfs:
        condition: service_healthy
    networks:
      - catwiki-network
    command: >
      sh -c "
        echo '==========================================' &&
        echo 'ğŸš€ å¼€å§‹åˆå§‹åŒ– CatWiki ç”Ÿäº§ç¯å¢ƒ...' &&
        echo '==========================================' &&
        echo '' &&
        echo 'ğŸ“¦ è¿è¡Œæ•°æ®åº“è¿ç§»...' &&
        uv run alembic upgrade head &&
        echo 'âœ… æ•°æ®åº“è¿ç§»å®Œæˆ' &&
        echo '' &&
        echo 'ğŸ“š åˆå§‹åŒ– Demo ç«™ç‚¹å’ŒåŒ»å­¦çŸ¥è¯†æ–‡æ¡£...' &&
        uv run python scripts/init_demo_data.py &&
        echo 'âœ… Demo æ•°æ®åˆå§‹åŒ–å®Œæˆ' &&
        echo '' &&
        echo 'ğŸ—„ï¸  åˆå§‹åŒ– RustFS å¯¹è±¡å­˜å‚¨...' &&
        uv run python scripts/init_rustfs.py &&
        echo 'âœ… RustFS åˆå§‹åŒ–å®Œæˆ' &&
        echo '' &&
        echo '==========================================' &&
        echo 'ğŸ‰ CatWiki ç”Ÿäº§ç¯å¢ƒåˆå§‹åŒ–å®Œæˆï¼' &&
        echo '==========================================' &&
        echo '' &&
        echo 'ğŸ“‹ é»˜è®¤ç®¡ç†å‘˜è´¦å·ï¼š' &&
        echo '   ğŸ“§ é‚®ç®±: admin@example.com' &&
        echo '   ğŸ”‘ å¯†ç : admin123' &&
        echo '' &&
        echo 'ğŸ“š Demo ç«™ç‚¹ï¼š' &&
        echo '   ğŸŒ åŸŸå: medical' &&
        echo '' &&
        echo '==========================================' &&
        echo ''
      "
    restart: "no"
    profiles:
      - init

  # FastAPI åç«¯æœåŠ¡
  backend:
    build:
      context: ../../backend
      dockerfile: Dockerfile.prod
    image: catwiki-backend:latest
    container_name: catwiki-backend-prod
    env_file:
      - .env.backend
    environment:
      # ç¯å¢ƒé…ç½®
      ENVIRONMENT: prod
      
      # æ•°æ®åº“é…ç½®
      POSTGRES_SERVER: postgres
      POSTGRES_PORT: 5432
      
      # RustFS å¯¹è±¡å­˜å‚¨é…ç½®
      RUSTFS_ENDPOINT: ${RUSTFS_ENDPOINT:-rustfs:9000}
    depends_on:
      postgres:
        condition: service_healthy
      rustfs:
        condition: service_healthy
      # æ³¨æ„ï¼šé¦–æ¬¡éƒ¨ç½²éœ€è¦å…ˆè¿è¡Œ docker compose --profile init up backend-init
      # åç»­éƒ¨ç½²ä¸éœ€è¦å†è¿è¡Œåˆå§‹åŒ–
    networks:
      - catwiki-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    # èµ„æºé™åˆ¶
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 1G
        reservations:
          cpus: '0.2'
          memory: 256M
    # æ—¥å¿—é…ç½®
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
    ports:
      - "127.0.0.1:${BACKEND_PORT:-3000}:3000"

  # ç®¡ç†åå°å‰ç«¯
  admin-frontend:
    build:
      context: ../../frontend/admin
      dockerfile: Dockerfile.prod
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://api.catwiki.cn}
    image: catwiki-admin:latest
    container_name: catwiki-admin-prod
    env_file:
      - .env.admin
    environment:
      NODE_ENV: production
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - catwiki-network
    restart: unless-stopped
    # èµ„æºé™åˆ¶
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    # æ—¥å¿—é…ç½®
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    ports:
      - "127.0.0.1:${ADMIN_PORT:-8001}:8001"

  # å®¢æˆ·ç«¯å‰ç«¯
  client-frontend:
    build:
      context: ../../frontend/client
      dockerfile: Dockerfile.prod
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://api.catwiki.cn}
        NEXT_PUBLIC_DOCS_URL: ${NEXT_PUBLIC_DOCS_URL:-http://docs.catwiki.cn}
    image: catwiki-client:latest
    container_name: catwiki-client-prod
    env_file:
      - .env.client
    environment:
      NODE_ENV: production
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - catwiki-network
    restart: unless-stopped
    # èµ„æºé™åˆ¶
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    # æ—¥å¿—é…ç½®
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    ports:
      - "127.0.0.1:${CLIENT_PORT:-8002}:8002"

  # æ–‡æ¡£ç«™ç‚¹æœåŠ¡
  docs-frontend:
    build:
      context: ../../frontend/docs
      dockerfile: Dockerfile.prod
    image: catwiki-docs:latest
    container_name: catwiki-docs-prod
    restart: unless-stopped
    ports:
      - "127.0.0.1:${DOCS_PORT:-8003}:80"
    networks:
      - catwiki-network
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 128M
        reservations:
          cpus: '0.05'
          memory: 64M
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"

  # å®˜ç½‘æœåŠ¡
  # website:
  #   build:
  #     context: ../../frontend/website
  #     dockerfile: Dockerfile.prod
  #   image: catwiki-website:latest
  #   container_name: catwiki-website-prod
  #   restart: unless-stopped
  #   ports:
  #     - "127.0.0.1:${WEBSITE_PORT:-8004}:80"
  #   networks:
  #     - catwiki-network
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '0.2'
  #         memory: 128M
  #       reservations:
  #         cpus: '0.05'
  #         memory: 64M
  #   logging:
  #     driver: "json-file"
  #     options:
  #       max-size: "20m"
  #       max-file: "3"

networks:
  catwiki-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
  rustfs_data:
    driver: local
  rustfs_logs:
    driver: local

