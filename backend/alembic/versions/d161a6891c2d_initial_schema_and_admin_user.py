"""initial_schema_and_admin_user

Revision ID: d161a6891c2d
Revises:
Create Date: 2025-12-30 21:01:25.687934

"""
import hashlib
import secrets
from datetime import UTC, datetime

import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

from alembic import op

# revision identifiers, used by Alembic.
revision = 'd161a6891c2d'
down_revision = None
branch_labels = None
depends_on = None



def upgrade() -> None:
    # Enable vector extension
    op.execute("CREATE EXTENSION IF NOT EXISTS vector")

    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('collection',
    sa.Column('title', sa.String(length=200), nullable=False, comment='åˆé›†åç§°'),
    sa.Column('site_id', sa.Integer(), nullable=False, comment='æ‰€å±ç«™ç‚¹ID'),
    sa.Column('parent_id', sa.Integer(), nullable=True, comment='çˆ¶åˆé›†ID'),
    sa.Column('order', sa.Integer(), nullable=False, comment='æ’åº'),
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_collection_id'), 'collection', ['id'], unique=False)
    op.create_index(op.f('ix_collection_parent_id'), 'collection', ['parent_id'], unique=False)
    op.create_index(op.f('ix_collection_site_id'), 'collection', ['site_id'], unique=False)
    op.create_index(op.f('ix_collection_title'), 'collection', ['title'], unique=False)
    op.create_table('document',
    sa.Column('title', sa.String(length=200), nullable=False, comment='æ–‡ç« æ ‡é¢˜'),
    sa.Column('content', sa.Text(), nullable=True, comment='æ–‡ç« å†…å®¹(Markdown)'),
    sa.Column('summary', sa.Text(), nullable=True, comment='æ–‡ç« æ‘˜è¦'),
    sa.Column('cover_image', sa.String(length=500), nullable=True, comment='å°é¢å›¾ç‰‡URL'),
    sa.Column('site_id', sa.Integer(), nullable=False, comment='æ‰€å±ç«™ç‚¹ID'),
    sa.Column('collection_id', sa.Integer(), nullable=True, comment='æ‰€å±åˆé›†ID'),
    sa.Column('category', sa.String(length=100), nullable=True, comment='åˆ†ç±»'),
    sa.Column('author', sa.String(length=100), nullable=False, comment='ä½œè€…'),
    sa.Column('status', sa.String(length=20), nullable=False, comment='çŠ¶æ€: published, draft'),
    sa.Column('vector_status', sa.String(length=20), nullable=False, server_default='none', comment='å‘é‡åŒ–çŠ¶æ€: none, pending, processing, completed, failed'),
    sa.Column('vector_error', sa.Text(), nullable=True, comment='å‘é‡åŒ–å¤±è´¥é”™è¯¯ä¿¡æ¯'),
    sa.Column('vectorized_at', sa.DateTime(timezone=True), nullable=True, comment='æœ€åå‘é‡åŒ–å®Œæˆæ—¶é—´'),
    sa.Column('views', sa.Integer(), nullable=False, comment='æµè§ˆé‡'),
    sa.Column('reading_time', sa.Integer(), nullable=False, comment='é¢„è®¡é˜…è¯»æ—¶é—´(åˆ†é’Ÿ)'),
    sa.Column('tags', sa.JSON(), nullable=True, comment='æ ‡ç­¾åˆ—è¡¨'),
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_document_collection_id'), 'document', ['collection_id'], unique=False)
    op.create_index(op.f('ix_document_id'), 'document', ['id'], unique=False)
    op.create_index(op.f('ix_document_site_id'), 'document', ['site_id'], unique=False)
    op.create_index(op.f('ix_document_title'), 'document', ['title'], unique=False)
    op.create_index(op.f('ix_document_vector_status'), 'document', ['vector_status'], unique=False)
    op.create_table('system_configs',
    sa.Column('config_key', sa.String(length=100), nullable=False, comment="é…ç½®é”®ï¼Œå¦‚ 'ai_config', 'bot_config'"),
    sa.Column('config_value', postgresql.JSON(astext_type=sa.Text()), nullable=False, comment='é…ç½®å€¼ï¼ˆJSON æ ¼å¼ï¼‰'),
    sa.Column('description', sa.String(length=500), nullable=True, comment='é…ç½®é¡¹æè¿°'),
    sa.Column('is_active', sa.Boolean(), nullable=False, comment='æ˜¯å¦å¯ç”¨è¯¥é…ç½®'),
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_system_configs_config_key'), 'system_configs', ['config_key'], unique=True)
    op.create_index(op.f('ix_system_configs_id'), 'system_configs', ['id'], unique=False)
    op.create_table('users',
    sa.Column('name', sa.String(length=100), nullable=False, comment='ç”¨æˆ·å'),
    sa.Column('email', sa.String(length=255), nullable=False, comment='é‚®ç®±'),
    sa.Column('password_hash', sa.String(length=255), nullable=False, comment='å¯†ç å“ˆå¸Œ'),
    sa.Column('role', sa.Enum('ADMIN', 'SITE_ADMIN', 'EDITOR', name='userrole', native_enum=False, length=20), nullable=False, comment='ç”¨æˆ·è§’è‰²'),
    sa.Column('status', sa.Enum('ACTIVE', 'INACTIVE', 'PENDING', name='userstatus', native_enum=False, length=20), nullable=False, comment='ç”¨æˆ·çŠ¶æ€'),
    sa.Column('managed_site_ids', sa.String(length=500), nullable=True, comment='ç®¡ç†çš„ç«™ç‚¹IDåˆ—è¡¨ï¼Œé€—å·åˆ†éš”'),
    sa.Column('last_login_at', sa.DateTime(timezone=True), nullable=True, comment='æœ€åç™»å½•æ—¶é—´'),
    sa.Column('last_login_ip', sa.String(length=50), nullable=True, comment='æœ€åç™»å½•IP'),
    sa.Column('avatar_url', sa.String(length=500), nullable=True, comment='å¤´åƒURL'),
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_users_email'), 'users', ['email'], unique=True)
    op.create_index(op.f('ix_users_id'), 'users', ['id'], unique=False)
    op.create_table('sites',
    sa.Column('name', sa.String(length=100), nullable=False, comment='ç«™ç‚¹åç§°'),
    sa.Column('domain', sa.String(length=200), nullable=True, comment='ç«™ç‚¹åŸŸå'),
    sa.Column('description', sa.Text(), nullable=True, comment='ç«™ç‚¹æè¿°'),
    sa.Column('icon', sa.String(length=50), nullable=True, comment='å›¾æ ‡åç§°'),
    sa.Column('status', sa.String(length=20), nullable=False, comment='çŠ¶æ€: active(æ¿€æ´»), disabled(ç¦ç”¨)'),
    sa.Column('article_count', sa.Integer(), nullable=False, comment='æ–‡ç« æ•°é‡'),
    sa.Column('theme_color', sa.String(length=50), nullable=True, comment='ä¸»é¢˜è‰²'),
    sa.Column('layout_mode', sa.String(length=20), nullable=True, comment='å¸ƒå±€æ¨¡å¼: sidebar, top'),
    sa.Column('quick_questions', sa.JSON(), nullable=True, comment='å¿«é€Ÿé—®é¢˜é…ç½®ï¼ŒJSONæ•°ç»„æ ¼å¼'),
    sa.Column('bot_config', sa.JSON(), nullable=True, comment='æœºå™¨äººé…ç½®ï¼ŒåŒ…å«ç½‘é¡µæŒ‚ä»¶ã€APIç­‰'),
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('domain')
    )
    op.create_index(op.f('ix_sites_id'), 'sites', ['id'], unique=False)
    op.create_index(op.f('ix_sites_name'), 'sites', ['name'], unique=False)
    # ### end Alembic commands ###

    # æ•°æ®è¿ç§»ï¼šåˆ›å»ºé»˜è®¤ç®¡ç†å‘˜ç”¨æˆ·
    _create_default_admin_user()
    # æ•°æ®è¿ç§»ï¼šåˆ›å»º Demo ç«™ç‚¹
    _create_demo_site()


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    # æ•°æ®è¿ç§»ï¼šåˆ é™¤é»˜è®¤ç®¡ç†å‘˜ç”¨æˆ·
    _delete_default_admin_user()

    op.drop_index(op.f('ix_sites_name'), table_name='sites')
    op.drop_index(op.f('ix_sites_id'), table_name='sites')
    op.drop_table('sites')
    op.drop_index(op.f('ix_users_id'), table_name='users')
    op.drop_index(op.f('ix_users_email'), table_name='users')
    op.drop_table('users')
    op.drop_index(op.f('ix_system_configs_id'), table_name='system_configs')
    op.drop_index(op.f('ix_system_configs_config_key'), table_name='system_configs')
    op.drop_table('system_configs')
    op.drop_index(op.f('ix_document_vector_status'), table_name='document')
    op.drop_index(op.f('ix_document_title'), table_name='document')
    op.drop_index(op.f('ix_document_site_id'), table_name='document')
    op.drop_index(op.f('ix_document_id'), table_name='document')
    op.drop_index(op.f('ix_document_collection_id'), table_name='document')
    op.drop_table('document')
    op.drop_index(op.f('ix_collection_title'), table_name='collection')
    op.drop_index(op.f('ix_collection_site_id'), table_name='collection')
    op.drop_index(op.f('ix_collection_parent_id'), table_name='collection')
    op.drop_index(op.f('ix_collection_id'), table_name='collection')
    op.drop_table('collection')
    # ### end Alembic commands ###

    # Drop vector extension
    op.execute("DROP EXTENSION IF EXISTS vector")


def _get_password_hash(password: str) -> str:
    """
    ç”Ÿæˆå¯†ç å“ˆå¸Œ
    ä½¿ç”¨ SHA256 + salt
    """
    salt = secrets.token_hex(16)
    hash_value = hashlib.sha256((salt + password).encode()).hexdigest()
    return f"{salt}${hash_value}"


def _create_default_admin_user() -> None:
    """
    åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜ç”¨æˆ·
    é‚®ç®±: admin@example.com
    å¯†ç : admin123
    """
    # åˆ›å»º users è¡¨çš„å¼•ç”¨ï¼ˆDateTime éœ€è¦æŒ‡å®š timezone=True ä»¥åŒ¹é…å®é™…è¡¨å®šä¹‰ï¼‰
    users_table = sa.table(
        'users',
        sa.column('name', sa.String),
        sa.column('email', sa.String),
        sa.column('password_hash', sa.String),
        sa.column('role', sa.String),
        sa.column('status', sa.String),
        sa.column('managed_site_ids', sa.String),
        sa.column('created_at', sa.DateTime(timezone=True)),
        sa.column('updated_at', sa.DateTime(timezone=True)),
    )

    # æ£€æŸ¥ç®¡ç†å‘˜ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
    conn = op.get_bind()
    result = conn.execute(
        sa.text("SELECT COUNT(*) FROM users WHERE email = :email"),
        {"email": "admin@example.com"}
    )
    count = result.scalar()

    # å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º
    if count == 0:
        now = datetime.now(UTC)
        op.bulk_insert(
            users_table,
            [
                {
                    'name': 'Admin',
                    'email': 'admin@example.com',
                    'password_hash': _get_password_hash('admin123'),
                    'role': 'ADMIN',
                    'status': 'ACTIVE',
                    'managed_site_ids': '',
                    'created_at': now,
                    'updated_at': now,
                }
            ]
        )
        print("âœ… åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜ç”¨æˆ·ï¼šadmin@example.com / admin123")
    else:
        print("âš ï¸  ç®¡ç†å‘˜ç”¨æˆ·å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º")


def _delete_default_admin_user() -> None:
    """
    åˆ é™¤é»˜è®¤ç®¡ç†å‘˜ç”¨æˆ·
    """
    conn = op.get_bind()
    conn.execute(
        sa.text("DELETE FROM users WHERE email = :email"),
        {"email": "admin@example.com"}
    )
    print("ğŸ—‘ï¸  åˆ é™¤é»˜è®¤ç®¡ç†å‘˜ç”¨æˆ·ï¼šadmin@example.com")


def _create_demo_site() -> None:
    """
    åˆ›å»º Demo ç«™ç‚¹åŠåˆå§‹åŒ–å¿«é€Ÿé—®é¢˜
    """
    sites_table = sa.table(
        'sites',
        sa.column('name', sa.String),
        sa.column('domain', sa.String),
        sa.column('description', sa.String),
        sa.column('icon', sa.String),
        sa.column('status', sa.String),
        sa.column('article_count', sa.Integer),
        sa.column('theme_color', sa.String),
        sa.column('layout_mode', sa.String),
        sa.column('quick_questions', sa.JSON),
        sa.column('bot_config', sa.JSON),
        sa.column('created_at', sa.DateTime(timezone=True)),
        sa.column('updated_at', sa.DateTime(timezone=True)),
    )

    # æ£€æŸ¥ Demo ç«™ç‚¹æ˜¯å¦å·²å­˜åœ¨
    conn = op.get_bind()
    result = conn.execute(
        sa.text("SELECT COUNT(*) FROM sites WHERE domain = :domain"),
        {"domain": "medical"}
    )
    count = result.scalar()

    if count == 0:
        now = datetime.now(UTC)
        quick_questions = [
            {"text": "é«˜è¡€å‹æœ‰å“ªäº›å±å®³ï¼Ÿ", "category": "å¸¸è§ç–¾ç—…"},
            {"text": "å¦‚ä½•è¿›è¡Œå¿ƒè‚ºå¤è‹ï¼Ÿ", "category": "æ€¥æ•‘çŸ¥è¯†"},
            {"text": "æ—¥å¸¸é¥®é£Ÿåº”è¯¥æ³¨æ„ä»€ä¹ˆï¼Ÿ", "category": "å¥åº·ç”Ÿæ´»"}
        ]
        
        op.bulk_insert(
            sites_table,
            [
                {
                    'name': 'åŒ»å­¦ç§‘æ™®',
                    'domain': 'medical',
                    'description': 'åŒ»å­¦çŸ¥è¯†ç§‘æ™®ç«™ç‚¹ï¼Œæä¾›å¸¸è§ç–¾ç—…ã€å¥åº·ç”Ÿæ´»ã€æ€¥æ•‘çŸ¥è¯†ç­‰å†…å®¹',
                    'icon': 'medical',
                    'status': 'active',
                    'article_count': 0,
                    'theme_color': 'blue',
                    'layout_mode': 'sidebar',
                    'quick_questions': quick_questions,
                    'created_at': now,
                    'updated_at': now,
                }
            ]
        )
        print("âœ… åˆ›å»º Demo ç«™ç‚¹åŠå…¶å¿«é€Ÿé—®é¢˜é…ç½®")
    else:
        print("âš ï¸  Demo ç«™ç‚¹å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º")


